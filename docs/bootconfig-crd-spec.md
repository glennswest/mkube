# BootConfig CRD Specification

## Overview

Store boot config files (ignition, kickstart, etc.) in mkube, assigned to BareMetalHost objects. Booting servers fetch their config via `GET /api/v1/bootconfig` — mkube identifies the server by source IP and returns the config assigned to that host. Same pattern as cloud instance metadata services.

## How It Works

1. Admin creates a `BootConfig` object with a config file (ignition JSON, kickstart, etc.)
2. Admin assigns the boot config to a BMH: `bmh.spec.bootConfig = "coreos-builder"`
3. Server sanboots a CoreOS/Fedora ISO via iSCSI
4. ISO's kernel args include `ignition.config.url=http://192.168.200.2:8082/api/v1/bootconfig`
5. mkube receives the request, looks up the source IP → finds the BMH → returns that BMH's assigned boot config
6. No config name in the URL — the server just asks "give me my config" and mkube figures it out

## CRD

```yaml
apiVersion: v1
kind: BootConfig
metadata:
  name: coreos-builder
spec:
  config: |
    {
      "ignition": { "version": "3.4.0" },
      ...
    }
status:
  phase: Ready
  size: 4096
```

## Types

```go
type BootConfig struct {
    metav1.TypeMeta   `json:",inline"`
    metav1.ObjectMeta `json:"metadata"`
    Spec              BootConfigSpec   `json:"spec"`
    Status            BootConfigStatus `json:"status,omitempty"`
}

type BootConfigSpec struct {
    Config string `json:"config"` // raw config file content
}

type BootConfigStatus struct {
    Phase string `json:"phase"`          // Ready, Error
    Size  int64  `json:"size,omitempty"` // bytes
}

type BootConfigList struct {
    metav1.TypeMeta `json:",inline"`
    metav1.ListMeta `json:"metadata"`
    Items           []BootConfig `json:"items"`
}
```

## BMH Change

Add `bootConfig` field to BMHSpec:

```go
type BMHSpec struct {
    // ... existing fields ...
    BootConfig string `json:"bootConfig,omitempty"` // name of BootConfig to serve for this host
}
```

```yaml
apiVersion: v1
kind: BareMetalHost
metadata:
  name: server1
  namespace: g10
spec:
  bootMACAddress: "AC:1F:6B:8A:A7:9C"
  ip: "192.168.10.10"
  bootConfig: "coreos-builder"    # ← references BootConfig by name
```

## API Endpoints

### CRUD (management)

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/v1/bootconfigs` | List all configs |
| GET | `/api/v1/bootconfigs/{name}` | Get config object (JSON with metadata) |
| POST | `/api/v1/bootconfigs` | Create a config |
| PUT | `/api/v1/bootconfigs/{name}` | Update a config |
| DELETE | `/api/v1/bootconfigs/{name}` | Delete a config |

### Serving endpoint (used by booting servers)

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/v1/bootconfig` | Return the config for the requesting server |

**Resolution logic:**

1. Get source IP from request (remote addr)
2. Find BMH where `spec.ip` matches the source IP
3. Read `bmh.spec.bootConfig` → look up that `BootConfig` object
4. Return `spec.config` as `text/plain`
5. No BMH found or no bootConfig assigned → `404`

One URL for all servers. Every ISO has the same kernel arg. Each server gets its own config.

## Storage

- **Bucket:** `BOOTCONFIGS` in NATS KV store
- **Key:** `{name}`
- **Value:** JSON-serialized `BootConfig`

Cluster-scoped (no namespace).

## Usage

### Create configs

```bash
# Create the live installer config
curl -X POST http://192.168.200.2:8082/api/v1/bootconfigs \
  -H 'Content-Type: application/json' \
  -d '{
    "metadata": { "name": "coreos-builder" },
    "spec": { "config": "{\"ignition\":{\"version\":\"3.4.0\"}, ...}" }
  }'

# Create the target system config
curl -X POST http://192.168.200.2:8082/api/v1/bootconfigs \
  -H 'Content-Type: application/json' \
  -d '{
    "metadata": { "name": "builder-target" },
    "spec": { "config": "variant: fcos\nversion: 1.5.0\n..." }
  }'
```

### Assign to a host

```bash
curl -X PUT http://192.168.200.2:8082/api/v1/namespaces/g10/baremetalhosts/server1 \
  -H 'Content-Type: application/json' \
  -d '{ "spec": { "bootConfig": "coreos-builder" } }'
```

### Server fetches its own config (automatic — happens during boot)

```bash
# From server1 (192.168.10.10):
curl http://192.168.200.2:8082/api/v1/bootconfig
# → returns the coreos-builder ignition JSON
```

### ISO kernel args (baked into ISO GRUB config once)

CoreOS live ISO:
```
ignition.config.url=http://192.168.200.2:8082/api/v1/bootconfig
```

Fedora netinstall ISO:
```
inst.ks=http://192.168.200.2:8082/api/v1/bootconfig
```

### iPXE sanboot (generated by pxemanager)

```
#!ipxe
sanboot iscsi:192.168.10.1::::iqn.2000-02.com.mikrotik:cdrom-coreos-live
```

## Example Configs

### coreos-builder (live ignition — installs to disk then reboots)

```json
{
  "ignition": { "version": "3.4.0" },
  "systemd": {
    "units": [{
      "name": "coreos-installer.service",
      "enabled": true,
      "contents": "[Unit]\nDescription=Install CoreOS to disk\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/coreos-installer install /dev/sda --ignition-url http://192.168.200.2:8082/api/v1/bootconfig --insecure-ignition --append-karg console=tty0 --append-karg console=ttyS0,115200n8 --append-karg console=ttyS1,115200n8\nExecStartPost=/usr/bin/systemctl reboot\nStandardOutput=journal+console\nStandardError=journal+console\n\n[Install]\nWantedBy=multi-user.target\n"
    }]
  }
}
```

Note: after `coreos-installer` reboots, the server boots from disk. On disk boot, the BMH's `bootConfig` should be updated to `builder-target` (the post-install config). This can be handled by pxemanager's `boot_local_after` logic — when it switches to localboot, it also switches the bootConfig.

### builder-target (applied to installed system)

Full `builder.bu` content: SSH keys, podman, cockpit, buildah/skopeo, serial consoles, firewall.

### fedora-server (kickstart)

```
install
url --url=https://download.fedoraproject.org/pub/fedora/linux/releases/43/Everything/x86_64/os/
keyboard us
lang en_US.UTF-8
timezone UTC
rootpw --plaintext admin
sshkey --username=root "ssh-rsa AAAA..."
bootloader --location=mbr --append="console=tty0 console=ttyS0,115200n8 console=ttyS1,115200n8"
clearpart --all --initlabel
autopart
reboot
%packages
@^server-product-environment
%end
```

## Changes to Other CRDs

| CRD | Change |
|-----|--------|
| BareMetalHost | Add `spec.bootConfig` field (string, references BootConfig name) |
| ISCSICdrom | No changes |

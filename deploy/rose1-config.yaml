# microkube configuration for rose1.gw.lo (ROSE Data Server)
# This file is mounted at /etc/microkube/config.yaml inside the container.
#
# The container runs ON the router at 192.168.200.2 and accesses the
# RouterOS REST API at 192.168.200.1 (the bridge gateway).

nodeName: rose1
standalone: true

routeros:
  address: "192.168.200.1:8728"
  restUrl: "http://192.168.200.1/rest"
  user: mkube
  password: "mkube-rest"
  useTLS: false

# Statically configured networks. Discovery will auto-populate DNS config
# for any of these that lack it, and add new networks found on the device.
networks:
  - name: gt
    bridge: bridge-gt
    cidr: "192.168.200.0/24"
    gateway: "192.168.200.1"
    dns:
      endpoint: "http://192.168.200.199:8080"
      zone: "gt.lo"
      server: "192.168.200.199"
  - name: g10
    bridge: bridge
    cidr: "192.168.10.0/24"
    gateway: "192.168.10.1"
    dns:
      endpoint: "http://192.168.10.199:8080"
      zone: "g10.lo"
      server: "192.168.10.199"
  - name: g11
    bridge: bridge-boot
    cidr: "192.168.11.0/24"
    gateway: "192.168.11.1"
    dns:
      endpoint: "http://192.168.11.199:8080"
      zone: "g11.lo"
      server: "192.168.11.199"
  - name: gw
    bridge: bridge-lan
    cidr: "192.168.1.0/24"
    gateway: "192.168.1.88"
    dns:
      endpoint: "http://192.168.1.199:8080"
      zone: "gw.lo"
      server: "192.168.1.199"

storage:
  basePath: /raid1/images
  tarballCache: /raid1/cache
  gcIntervalMinutes: 60
  gcKeepLastN: 10
  gcDryRun: false

lifecycle:
  bootManifestPath: /etc/microkube/boot-order.yaml
  watchdogIntervalSeconds: 5
  maxRestarts: 5
  restartCooldown: 10

dzo:
  enabled: true
  listenAddr: ":8082"
  statePath: /etc/microkube/dzo-state.yaml
  microdnsImage: "192.168.200.2:5000/microdns:latest"
  defaultMode: "nested"

registry:
  enabled: true
  listenAddr: ":5000"
  storePath: /raid1/registry
  localAddresses:
    - "192.168.200.2:5000"
  pullThrough: true
  upstreamRegistries:
    - "docker.io"
    - "ghcr.io"
  # Poll GHCR for new image digests every 2 minutes.
  # New images are mirrored locally and trigger rolling updates
  # for pods with vkube.io/image-policy: auto.
  watchPollSeconds: 120
  watchImages:
    - upstream: "ghcr.io/glenneth/microkube:latest"
      localRepo: "microkube"
    - upstream: "ghcr.io/glenneth/mkube-update:latest"
      localRepo: "mkube-update"
    - upstream: "ghcr.io/glenneth/microdns:latest"
      localRepo: "microdns"

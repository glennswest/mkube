# mkube configuration for rose1.gw.lo (ROSE Data Server)
# This file is mounted at /etc/mkube/config.yaml inside the container.
#
# The container runs ON the router at 192.168.200.2 and accesses the
# RouterOS REST API at 192.168.200.1 (the bridge gateway).

nodeName: rose1
standalone: true

routeros:
  address: "192.168.200.1:8728"
  restUrl: "http://192.168.200.1/rest"
  user: mkube
  password: "mkube-rest"
  useTLS: false

# Statically configured networks. Discovery will auto-populate DNS config
# for any of these that lack it, and add new networks found on the device.
networks:
  - name: gt
    bridge: bridge-gt
    cidr: "192.168.200.0/24"
    gateway: "192.168.200.1"
    dns:
      endpoint: "http://192.168.200.199:8080"
      zone: "gt.lo"
      server: "192.168.200.199"
      staticRecords:
        - name: rose1
          ip: "192.168.200.1"
        - name: dns
          ip: "192.168.200.199"
        - name: nats
          ip: "192.168.200.10"
        - name: mkube
          ip: "192.168.200.2"
        - name: registry
          ip: "192.168.200.3"
  - name: g10
    bridge: bridge
    cidr: "192.168.10.0/24"
    gateway: "192.168.10.1"
    ipamStart: "192.168.10.200"
    ipamEnd: "192.168.10.250"
    dns:
      endpoint: "http://192.168.10.252:8080"
      zone: "g10.lo"
      server: "192.168.10.252"
      staticRecords:
        - name: rose1
          ip: "192.168.10.1"
        - name: dns
          ip: "192.168.10.252"
        - name: pxe
          ip: "192.168.10.200"
      dhcp:
        enabled: true
        rangeStart: "192.168.10.100"
        rangeEnd: "192.168.10.199"
        leaseTime: 600
        nextServer: "192.168.10.200"
        bootFile: "undionly.kpxe"
        bootFileEfi: "ipxe.efi"
        reservations:
          - mac: "AC:1F:6B:8A:A7:9C"
            ip: "192.168.10.10"
            hostname: "server1"
          - mac: "F4:52:14:84:B7:E0"
            ip: "192.168.10.20"
            hostname: "server1b"
          - mac: "AC:1F:6B:8B:11:5D"
            ip: "192.168.10.11"
            hostname: "server2"
          - mac: "F4:52:14:84:BC:C0"
            ip: "192.168.10.21"
            hostname: "server2b"
          - mac: "AC:1F:6B:8A:A4:5C"
            ip: "192.168.10.12"
            hostname: "server3"
          - mac: "F4:52:14:84:86:F0"
            ip: "192.168.10.22"
            hostname: "server3b"
          - mac: "AC:1F:6B:8A:9B:E2"
            ip: "192.168.10.13"
            hostname: "server4"
          - mac: "F4:52:14:84:5F:A0"
            ip: "192.168.10.23"
            hostname: "server4b"
          - mac: "AC:1F:6B:8A:A3:1A"
            ip: "192.168.10.14"
            hostname: "server5"
          - mac: "F4:52:14:84:6F:F0"
            ip: "192.168.10.24"
            hostname: "server5b"
          - mac: "AC:1F:6B:8D:90:13"
            ip: "192.168.10.15"
            hostname: "server6"
          - mac: "F4:52:14:84:B7:D0"
            ip: "192.168.10.25"
            hostname: "server6b"
          - mac: "00:00:00:00:00:00"
            ip: "192.168.10.16"
            hostname: "server7"
          - mac: "00:00:00:00:00:01"
            ip: "192.168.10.26"
            hostname: "server7b"
          - mac: "AC:1F:6B:8A:A3:96"
            ip: "192.168.10.17"
            hostname: "server8"
          - mac: "F4:52:14:84:AE:30"
            ip: "192.168.10.27"
            hostname: "server8b"
          - mac: "FC:4C:EA:F9:4F:2F"
            ip: "192.168.10.50"
            hostname: "gb10"
          - mac: "FC:4C:EA:F9:4F:33"
            ip: "192.168.10.51"
            hostname: "gb10b"
          - mac: "50:6B:4B:B1:9E:26"
            ip: "192.168.10.30"
            hostname: "server30"
          - mac: "50:6B:4B:B1:9E:27"
            ip: "192.168.10.31"
            hostname: "server30b"
          - mac: "D0:11:E5:A0:1A:A4"
            ip: "192.168.10.190"
            hostname: "macmini"
  - name: g11
    bridge: bridge-boot
    cidr: "192.168.11.0/24"
    gateway: "192.168.11.1"
    ipamStart: "192.168.11.200"
    ipamEnd: "192.168.11.250"
    dns:
      endpoint: "http://192.168.11.252:8080"
      zone: "g11.lo"
      server: "192.168.11.252"
      staticRecords:
        - name: rose1
          ip: "192.168.11.1"
        - name: dns
          ip: "192.168.11.252"
      dhcp:
        enabled: true
        rangeStart: "192.168.11.150"
        rangeEnd: "192.168.11.180"
        leaseTime: 600
        nextServer: "192.168.10.9"
        bootFile: "pxelinux.0"
        reservations:
          - mac: "0C:C4:7A:02:6B:90"
            ip: "192.168.11.10"
            hostname: "server1"
          - mac: "0C:C4:7A:02:6B:2A"
            ip: "192.168.11.11"
            hostname: "server2"
          - mac: "0C:C4:7A:02:6B:37"
            ip: "192.168.11.12"
            hostname: "server3"
          - mac: "0C:C4:7A:02:6B:C0"
            ip: "192.168.11.13"
            hostname: "server4"
          - mac: "0C:C4:7A:02:6B:1E"
            ip: "192.168.11.14"
            hostname: "server5"
          - mac: "0C:C4:7A:02:6C:A6"
            ip: "192.168.11.15"
            hostname: "server6"
          - mac: "00:00:00:00:00:00"
            ip: "192.168.11.16"
            hostname: "server7"
          - mac: "0C:C4:7A:02:6B:2E"
            ip: "192.168.11.17"
            hostname: "server8"
          - mac: "14:18:77:62:5D:0C"
            ip: "192.168.11.30"
            hostname: "server30"
  - name: gw
    bridge: bridge-lan
    cidr: "192.168.1.0/24"
    gateway: "192.168.1.88"
    externalDNS: true  # DNS server runs on pvex.gw.lo, not managed by mkube
    dns:
      endpoint: "http://192.168.1.199:8080"
      zone: "gw.lo"
      server: "192.168.1.199"
      staticRecords:
        - name: rose1
          ip: "192.168.1.88"
        - name: dns
          ip: "192.168.1.199"

storage:
  basePath: /raid1/images
  tarballCache: /raid1/cache
  selfRootDir: raid1/images/kube.gt.lo
  persistentMounts:
    - containerPath: "/raid1/cache"
      hostPath: "raid1/cache"
    - containerPath: "/raid1/iso"
      hostPath: "raid1/iso"
    - containerPath: "/data"
      hostPath: "raid1/volumes/kube.gt.lo/data"
  gcIntervalMinutes: 60
  gcKeepLastN: 10
  gcDryRun: false

lifecycle:
  bootManifestPath: /etc/mkube/boot-order.yaml
  watchdogIntervalSeconds: 5
  maxRestarts: 5
  restartCooldown: 10

dzo:
  enabled: true
  listenAddr: ":8082"
  statePath: /etc/mkube/dzo-state.yaml
  microdnsImage: "192.168.200.3:5000/microdns:latest"
  defaultMode: "nested"

namespace:
  statePath: /etc/mkube/namespace-state.yaml
  defaultMode: "nested"

logging:
  enabled: true
  url: "http://logging.kube.gt.lo:8084"

nats:
  url: "nats://192.168.200.10:4222"
  replicas: 1

bmh:
  pxeManagerURL: "http://pxe.g10.lo:8080"
  dhcpLeaseURL: "http://192.168.11.252:8080"
  watchInterval: 30

# Registry runs as a standalone container (mkube-registry) at 192.168.200.3:5000.
# mkube no longer runs the embedded registry — it receives push notifications
# via the webhook endpoint POST /api/v1/registry/push-notify.
registry:
  enabled: false
  localAddresses:
    - "192.168.200.3:5000"
    - "192.168.200.2:5000"  # legacy alias — rewritten to primary
    - "registry.gt.lo:5000"  # DNS alias — rewritten to primary

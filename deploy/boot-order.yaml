# Boot order manifest for mkube standalone reconciler on rose1.gw.lo
#
# Defines all containers managed by mkube. The standalone reconciler
# reads this file and ensures each pod exists on the RouterOS device.
#
# Annotations:
#   vkube.io/network       — target network name (default: first in config)
#   vkube.io/boot-priority — lower = starts earlier (default: container index * 10)
#   vkube.io/depends-on    — comma-separated container names to wait for
#   vkube.io/file          — host tarball path (skips OCI image pull)
#   vkube.io/image-policy  — "auto" to redeploy when image is pushed to registry
#
# Networks on rose1 (auto-discovered + static config):
#   gt   — bridge-gt    192.168.200.0/24  dns: gt.lo   (192.168.200.199)
#   g10  — bridge       192.168.10.0/24   dns: g10.lo  (192.168.10.199)
#   g11  — bridge-boot  192.168.11.0/24   dns: g11.lo  (192.168.11.199)
#   gw   — bridge-lan   192.168.1.0/24    dns: gw.lo   (192.168.1.199)

# ── MicroDNS instances (priority 10 — start first) ─────────────────────────
# DNS servers for each subnet. All other services depend on these.
# All 4 share the same image — pushing a new microdns:latest to the
# embedded registry triggers a rolling update of all instances.

---
apiVersion: v1
kind: Pod
metadata:
  name: mdns-gw
  namespace: dns
  annotations:
    vkube.io/network: gw
    vkube.io/boot-priority: "10"
    vkube.io/image-policy: auto
spec:
  restartPolicy: Always
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

---
apiVersion: v1
kind: Pod
metadata:
  name: mdns-g10
  namespace: dns
  annotations:
    vkube.io/network: g10
    vkube.io/boot-priority: "11"
    vkube.io/image-policy: auto
spec:
  restartPolicy: Always
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

---
apiVersion: v1
kind: Pod
metadata:
  name: mdns-g11
  namespace: dns
  annotations:
    vkube.io/network: g11
    vkube.io/boot-priority: "12"
    vkube.io/image-policy: auto
spec:
  restartPolicy: Always
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

---
apiVersion: v1
kind: Pod
metadata:
  name: mdns-gt
  namespace: dns
  annotations:
    vkube.io/network: gt
    vkube.io/boot-priority: "13"
    vkube.io/image-policy: auto
spec:
  restartPolicy: Always
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

# ── Network manager (priority 20 — after DNS) ──────────────────────────────

---
apiVersion: v1
kind: Pod
metadata:
  name: network-gw
  namespace: infra
  annotations:
    vkube.io/network: g10
    vkube.io/boot-priority: "20"
    vkube.io/depends-on: "mdns-gw-microdns,mdns-g10-microdns"
    vkube.io/file: "raid1/tarballs/netman.tar"
spec:
  restartPolicy: Always
  containers:
    - name: netman
      image: localhost/netman:latest
      volumeMounts:
        - name: data
          mountPath: /data

# ── Fast registry (priority 40) ────────────────────────────────────────────

---
apiVersion: v1
kind: Pod
metadata:
  name: fastregistry-g10
  namespace: infra
  annotations:
    vkube.io/network: g10
    vkube.io/boot-priority: "40"
spec:
  restartPolicy: Always
  containers:
    - name: registry
      image: localhost/fastregistry:edge
      volumeMounts:
        - name: config
          mountPath: /etc/fastregistry
        - name: data
          mountPath: /data

# ── Agent monitor (priority 50) ────────────────────────────────────────────

---
apiVersion: v1
kind: Pod
metadata:
  name: agentmonitor-g10
  namespace: monitoring
  annotations:
    vkube.io/network: g10
    vkube.io/boot-priority: "50"
spec:
  restartPolicy: Always
  containers:
    - name: monitor
      image: localhost/agent-monitor:edge
      command: ["/agent-monitor"]

# ── mkube-console (priority 60) ────────────────────────────────────────────

---
apiVersion: v1
kind: Pod
metadata:
  name: mkube-console
  namespace: infra
  annotations:
    vkube.io/network: gt
    vkube.io/boot-priority: "60"
    vkube.io/image-policy: auto
    vkube.io/aliases: "console"
spec:
  restartPolicy: Always
  volumes:
    - name: config
      configMap:
        name: mkube-console-config
  containers:
    - name: console
      image: ghcr.io/glennswest/mkube-console:edge
      livenessProbe:
        httpGet:
          path: /healthz
          port: 9090
        periodSeconds: 30
      volumeMounts:
        - name: config
          mountPath: /etc/mkube-console

# ── Logging (priority 65 — before update manager) ────────────────────────

---
apiVersion: v1
kind: Pod
metadata:
  name: micrologs
  namespace: infra
  annotations:
    vkube.io/network: gt
    vkube.io/boot-priority: "65"
    vkube.io/aliases: "logging"
    vkube.io/image-policy: auto
spec:
  restartPolicy: Always
  containers:
    - name: micrologs
      image: 192.168.200.2:5000/micrologs:edge
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8084
        periodSeconds: 30
      volumeMounts:
        - name: logs
          mountPath: /raid1/logs

---
apiVersion: v1
kind: Pod
metadata:
  name: logcollector
  namespace: infra
  annotations:
    vkube.io/network: gt
    vkube.io/boot-priority: "66"
    vkube.io/depends-on: "micrologs-micrologs"
    vkube.io/image-policy: auto
spec:
  restartPolicy: Always
  containers:
    - name: collector
      image: 192.168.200.2:5000/micrologs-collector-routeros:edge
      volumeMounts:
        - name: config
          mountPath: /etc/micrologs-collector

# ── Update manager ────────────────────────────────────────────────────────
# mkube-update is deployed separately as a bootstrap init container.
# It is NOT managed by mkube's boot-order reconciler.
# Deploy with: make deploy-update

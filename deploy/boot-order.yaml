# Bootstrap manifest for mkube standalone reconciler on rose1.gw.lo
#
# Only contains infrastructure pods needed BEFORE the NATS database is
# available. All other pods are deployed via `oc apply` and persisted
# in NATS JetStream — they survive reboots without being listed here.
#
# Annotations:
#   vkube.io/network       — target network name (default: first in config)
#   vkube.io/boot-priority — lower = starts earlier (default: container index * 10)
#   vkube.io/depends-on    — comma-separated container names to wait for
#   vkube.io/file          — host tarball path (skips OCI image pull)
#   vkube.io/image-policy  — "auto" to redeploy when image is pushed to registry
#
# Networks on rose1 (auto-discovered + static config):
#   gt   — bridge-gt    192.168.200.0/24  dns: gt.lo   (192.168.200.199)
#   g10  — bridge       192.168.10.0/24   dns: g10.lo  (192.168.10.199)
#   g11  — bridge-boot  192.168.11.0/24   dns: g11.lo  (192.168.11.199)
#   gw   — bridge-lan   192.168.1.0/24    dns: gw.lo   (192.168.1.199)

# ── NATS JetStream (priority 5 — before DNS) ─────────────────────────────────
# Distributed key-value store for persistent pod/configmap state.
# File-backed JetStream on /data for durability across restarts.

---
apiVersion: v1
kind: Pod
metadata:
  name: nats
  namespace: infra
  annotations:
    vkube.io/network: gt
    vkube.io/boot-priority: "5"
    vkube.io/image-policy: auto
    vkube.io/static-ip: "192.168.200.10"
spec:
  restartPolicy: Always
  containers:
    - name: nats
      image: 192.168.200.2:5000/nats:edge
      command: ["nats-server", "-js", "--store_dir", "/data", "--addr", "0.0.0.0"]
      startupProbe:
        tcpSocket:
          port: 4222
        initialDelaySeconds: 2
        periodSeconds: 2
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8222
        periodSeconds: 30
        failureThreshold: 3
      volumeMounts:
        - name: data
          mountPath: /data

# ── MicroDNS instances (priority 10) ─────────────────────────────────────────
# DNS servers for each subnet. Recursor ConfigMaps are auto-generated
# from network config in defaults.go — no manual ConfigMaps needed.

---
apiVersion: v1
kind: Pod
metadata:
  name: dns
  namespace: gw
  annotations:
    vkube.io/network: gw
    vkube.io/boot-priority: "10"
    vkube.io/image-policy: auto
    vkube.io/file: "raid1/tarballs/microdns-arm64.tar"
    vkube.io/static-ip: "192.168.1.199"
spec:
  restartPolicy: Always
  volumes:
    - name: config
      configMap:
        name: dns-config
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

---
apiVersion: v1
kind: Pod
metadata:
  name: dns
  namespace: g10
  annotations:
    vkube.io/network: g10
    vkube.io/boot-priority: "11"
    vkube.io/image-policy: auto
    vkube.io/file: "raid1/tarballs/microdns-arm64.tar"
    vkube.io/static-ip: "192.168.10.199"
spec:
  restartPolicy: Always
  volumes:
    - name: config
      configMap:
        name: dns-config
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

---
apiVersion: v1
kind: Pod
metadata:
  name: dns
  namespace: g11
  annotations:
    vkube.io/network: g11
    vkube.io/boot-priority: "12"
    vkube.io/image-policy: auto
    vkube.io/file: "raid1/tarballs/microdns-arm64.tar"
    vkube.io/static-ip: "192.168.11.199"
spec:
  restartPolicy: Always
  volumes:
    - name: config
      configMap:
        name: dns-config
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

---
apiVersion: v1
kind: Pod
metadata:
  name: dns
  namespace: gt
  annotations:
    vkube.io/network: gt
    vkube.io/boot-priority: "13"
    vkube.io/image-policy: auto
    vkube.io/file: "raid1/tarballs/microdns-arm64.tar"
    vkube.io/static-ip: "192.168.200.199"
spec:
  restartPolicy: Always
  volumes:
    - name: config
      configMap:
        name: dns-config
  containers:
    - name: microdns
      image: 192.168.200.2:5000/microdns:edge
      startupProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
        failureThreshold: 10
      livenessProbe:
        httpGet:
          path: /api/v1/zones
          port: 8080
        periodSeconds: 30
        failureThreshold: 3
      readinessProbe:
        tcpSocket:
          port: 53
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/microdns
        - name: data
          mountPath: /data

# ── Update manager ────────────────────────────────────────────────────────
# mkube-update is deployed separately as a bootstrap init container.
# It is NOT managed by mkube's boot-order reconciler.
# Deploy with: make deploy-update
